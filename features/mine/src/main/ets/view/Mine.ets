// ets/view/Mine.ets

import { UserManager, UserInfo } from 'login';
import { promptAction } from '@kit.ArkUI';


// ÂÆö‰πâÊé•Âè£Á±ªÂûã
interface QuickAccessItem {
  icon: string;
  text: string;
  badge: string;
}

interface CommonFunction {
  icon: string;
  text: string;
}

interface MoreFunction {
  icon: string;
  text: string;
  badge: string;
  color: string;
}

@Component
export default struct Mine {
  @State currentUser: UserInfo | null = null;
  @State isLoggedIn: boolean = false;
  private userManager: UserManager = UserManager.getInstance();
  onLogout: () => void = () => {};

  async aboutToAppear() {
    await this.loadUserInfo();
  }

  async loadUserInfo() {
    try {
      await this.userManager.initPreferences();
      const user = await this.userManager.getCurrentUser();
      this.currentUser = user;
      this.isLoggedIn = user !== null;
    } catch (err) {
      console.error('Failed to load user info:', err);
    }
  }

  async logout() {
    try {
      await this.userManager.logout();
      this.currentUser = null;
      this.isLoggedIn = false;
      promptAction.showToast({
        message: $r('app.string.logout')
      });
      
      // ÈÄÄÂá∫ÁôªÂΩïÂêéË∞ÉÁî®ÂõûË∞ÉÂáΩÊï∞
      setTimeout(() => {
        this.onLogout();
      }, 1000); // Âª∂Ëøü1ÁßíËÆ©Áî®Êà∑ÁúãÂà∞ÈÄÄÂá∫ÊàêÂäüÁöÑÊèêÁ§∫
    } catch (err) {
      console.error('Failed to logout:', err);
    }
  }

  // Âø´ÈÄüËÆøÈóÆÂäüËÉΩÊï∞ÊçÆ
  private quickAccessItems: QuickAccessItem[] = [
    { icon: 'üìß', text: 'Ê∂àÊÅØ', badge: '1' },
    { icon: '‚≠ê', text: 'Êî∂Ëóè', badge: '' },
    { icon: 'üïê', text: 'ÂéÜÂè≤', badge: '' },
    { icon: '‚ù§Ô∏è', text: 'Â∑≤Ëµû', badge: '' },
    { icon: 'üìã', text: 'Á®çÂêéÂê¨', badge: '' }
  ];

  // Â∏∏Áî®ÂäüËÉΩÊï∞ÊçÆ
  private commonFunctions: CommonFunction[] = [
    { icon: 'Aa', text: 'Â≠ó‰ΩìÂ≠óÂè∑ËÆæÁΩÆ' },
    { icon: 'üåô', text: 'Â§úÈó¥Ê®°Âºè' },
    { icon: 'üì∞', text: 'Ë¶ÅÈóª‰∏ªÁºñÁ≤æÈÄâ' },
    { icon: '‚ùì', text: 'Â∏ÆÂä©ÂèçÈ¶à' },
    { icon: 'üìÖ', text: 'ÊàëÁöÑÈòÖËØªÂë®Êä•' },
    { icon: '‚¨áÔ∏è', text: 'ÊàëÁöÑ‰∏ãËΩΩ' },
    { icon: 'üõ°Ô∏è', text: 'ÂÆâÂÖ®‰∏≠ÂøÉ' },
    { icon: '‚öôÔ∏è', text: 'Êõ¥Â§öËÆæÁΩÆ' }
  ];

  // Êõ¥Â§öÂäüËÉΩÊï∞ÊçÆ
  private moreFunctions: MoreFunction[] = [
    { icon: '‚ñ∂Ô∏è', text: 'ËÖæËÆØËßÜÈ¢ëVIP', badge: '', color: '#00C853' },
    { icon: '‚öæ', text: 'ËÖæËÆØ‰ΩìËÇ≤', badge: '', color: '#FF9800' },
    { icon: 'üí∞', text: 'ÊàëÁöÑËµÑ‰∫ß', badge: '', color: '#E91E63' },
    { icon: 'üéÆ', text: 'BonBon Ê∏∏Êàè', badge: '', color: '#9C27B0' },
    { icon: 'üìñ', text: 'BonBon ËØª‰π¶', badge: '', color: '#03A9F4' },
    { icon: 'üê∑', text: 'Ë¥¢ÂØåÁ≤æÈÄâ', badge: '', color: '#FF9800' },
    { icon: 'üë©', text: 'Êñ∞ÈóªÂ¶π', badge: 'AIÂä©Êâã', color: '#2196F3' },
    { icon: 'üéÅ', text: 'Á≠æÂà∞È¢ÜÁ¶èÂà©', badge: '', color: '#FFD700' }
  ];

  build() {
    Column() {
      if (this.isLoggedIn && this.currentUser) {
        // Â∑≤ÁôªÂΩïÁä∂ÊÄÅ
        Scroll() {
          Column() {
            // Áî®Êà∑‰ø°ÊÅØÂ§¥ÈÉ®Âå∫Âüü
            Row() {
              Blank()

              // Âè≥‰æßÂäüËÉΩÊåâÈíÆ
              Row() {
                Text('üìÖ')
                  .fontSize('16fp')
                  .margin({ right: '8vp' })
                Text('Êó•Á≠æ')
                  .fontSize('12fp')
                  .fontColor('#666666')
              }
              .margin({ right: '16vp' })

              Text('üì±')
                .fontSize('16fp')
            }
            .width('100%')
            .height('50vp')
            .padding({ left: '16vp', right: '16vp' })
            .justifyContent(FlexAlign.SpaceBetween)
            .margin({ top: '20vp', bottom: '20vp' })

            // Áî®Êà∑Â§¥ÂÉèÂíåÂü∫Êú¨‰ø°ÊÅØ
            Row() {
              // Â§¥ÂÉè
              Text('üë§')
                .fontSize('40fp')
                .width('60vp')
                .height('60vp')
                .textAlign(TextAlign.Center)
                .backgroundColor('#E0E0E0')
                .borderRadius('30vp')
                .margin({ right: '16vp' })

              Column() {
                // Áî®Êà∑ÂêçÂíåÂæΩÁ´†
                Row() {
                  Text(this.currentUser.username || 'euphoria')
                    .fontSize('20fp')
                    .fontWeight(FontWeight.Bold)
                    .fontColor('#000000')
                    .margin({ right: '8vp' })

                  Row() {
                    Text('‚≠ê')
                      .fontSize('12fp')
                    Text('0Êûö')
                      .fontSize('12fp')
                      .fontColor('#666666')
                  }
                  .padding({ left: '6vp', right: '6vp', top: '2vp', bottom: '2vp' })
                  .backgroundColor('#F5F5F5')
                  .borderRadius('10vp')
                }
                .margin({ bottom: '8vp' })

                // ÁªüËÆ°Êï∞ÊçÆ
                Row() {
                  Text('0ÂèëË°®')
                    .fontSize('14fp')
                    .fontColor('#666666')
                    .margin({ right: '16vp' })
                  
                  Text('0ÂÖ≥Ê≥®')
                    .fontSize('14fp')
                    .fontColor('#666666')
                    .margin({ right: '16vp' })
                  
                  Text('0Á≤â‰∏ù')
                    .fontSize('14fp')
                    .fontColor('#666666')
                }
              }

              Blank()

              Text('‚ñ∂')
                .fontSize('14fp')
                .fontColor('#999999')
            }
            .width('100%')
            .padding({ left: '16vp', right: '16vp' })
            .margin({ bottom: '20vp' })

            // ‰ºöÂëòÂíå‰∏ìÊ†èÂç°Áâá
            Row() {
              // ÊàëÁöÑ‰ºöÂëòÂç°Áâá
              Row() {
                Text('üîΩ')
                  .fontSize('20fp')
                  .fontColor('#FFD700')
                  .margin({ right: '8vp' })
                
                Column() {
                  Text('ÊàëÁöÑ‰ºöÂëò')
                    .fontSize('14fp')
                    .fontColor('#000000')
                    .fontWeight(FontWeight.Medium)
                    .margin({ bottom: '4vp' })
                  
                  Text('È¶ñÊúàÁâπÊÉ†‰ΩéËá≥2Êäò')
                    .fontSize('12fp')
                    .fontColor('#666666')
                }
              }
              .width('48%')
              .height('60vp')
              .padding({ left: '12vp', right: '12vp' })
              .backgroundColor('#FFFFFF')
              .borderRadius('8vp')
              .justifyContent(FlexAlign.Start)

              // ÊàëÁöÑ‰∏ìÊ†èÂç°Áâá
              Row() {
                Text('‚¨ú')
                  .fontSize('20fp')
                  .fontColor('#FFD700')
                  .margin({ right: '8vp' })
                
                Column() {
                  Text('ÊàëÁöÑ‰∏ìÊ†è')
                    .fontSize('14fp')
                    .fontColor('#000000')
                    .fontWeight(FontWeight.Medium)
                    .margin({ bottom: '4vp' })
                  
                  Text('È¢ÜÂüü‰∏ìÂÆ∂,‰∏ì‰∏öËß£ËØª')
                    .fontSize('12fp')
                    .fontColor('#666666')
                }
              }
              .width('48%')
              .height('60vp')
              .padding({ left: '12vp', right: '12vp' })
              .backgroundColor('#FFFFFF')
              .borderRadius('8vp')
              .justifyContent(FlexAlign.Start)
            }
            .width('100%')
            .padding({ left: '16vp', right: '16vp' })
            .justifyContent(FlexAlign.SpaceBetween)
            .margin({ bottom: '20vp' })

            // Âø´ÈÄüËÆøÈóÆÂõæÊ†áË°å
            Grid() {
              ForEach(this.quickAccessItems, (item: QuickAccessItem, index: number) => {
                GridItem() {
                  Column() {
                    Stack() {
                      Text(item.icon)
                        .fontSize('24fp')
                        .alignSelf(ItemAlign.Center)
                      
                      if (item.badge) {
                        Text(item.badge)
                          .fontSize('10fp')
                          .fontColor('#FFFFFF')
                          .backgroundColor('#FF0000')
                          .borderRadius('8vp')
                          .padding({ left: '4vp', right: '4vp', top: '2vp', bottom: '2vp' })
                          .position({ x: '20vp', y: '-5vp' })
                      }
                    }
                    .width('40vp')
                    .height('40vp')
                    .alignContent(Alignment.Center)
                    .margin({ bottom: '8vp' })

                    Text(item.text)
                      .fontSize('12fp')
                      .fontColor('#666666')
                  }
                  .width('100%')
                  .height('80vp')
                  .justifyContent(FlexAlign.Center)
                  .alignItems(HorizontalAlign.Center)
                }
              })
            }
            .columnsTemplate('1fr 1fr 1fr 1fr 1fr')
            .rowsTemplate('1fr')
            .width('100%')
            .height('80vp')
            .padding({ left: '16vp', right: '16vp' })
            .margin({ bottom: '20vp' })

            // Â∏∏Áî®ÂäüËÉΩÂå∫Âüü
            Column() {
              Text('Â∏∏Áî®ÂäüËÉΩ')
                .fontSize('16fp')
                .fontWeight(FontWeight.Medium)
                .fontColor('#000000')
                .alignSelf(ItemAlign.Start)
                .margin({ bottom: '12vp' })

              Grid() {
                ForEach(this.commonFunctions, (item: CommonFunction, index: number) => {
                  GridItem() {
                    Column() {
                      Text(item.icon)
                        .fontSize('24fp')
                        .margin({ bottom: '8vp' })

                      Text(item.text)
                        .fontSize('12fp')
                        .fontColor('#666666')
                        .textAlign(TextAlign.Center)
                    }
                    .width('100%')
                    .height('80vp')
                    .justifyContent(FlexAlign.Center)
                    .alignItems(HorizontalAlign.Center)
                  }
                })
              }
              .columnsTemplate('1fr 1fr 1fr 1fr')
              .rowsTemplate('1fr 1fr')
              .width('100%')
              .height('160vp')
            }
            .width('100%')
            .padding({ left: '16vp', right: '16vp' })
            .margin({ bottom: '20vp' })

            // Êõ¥Â§öÂäüËÉΩÂå∫Âüü
            Column() {
              Text('Êõ¥Â§öÂäüËÉΩ')
                .fontSize('16fp')
                .fontWeight(FontWeight.Medium)
                .fontColor('#000000')
                .alignSelf(ItemAlign.Start)
                .margin({ bottom: '12vp' })

              Grid() {
                ForEach(this.moreFunctions, (item: MoreFunction, index: number) => {
                  GridItem() {
                    Column() {
                      Stack() {
                        Text(item.icon)
                          .fontSize('20fp')
                          .fontColor(item.color)
                          .alignSelf(ItemAlign.Center)

                        if (item.badge) {
                          Text(item.badge)
                            .fontSize('8fp')
                            .fontColor('#FFFFFF')
                            .backgroundColor('#FF0000')
                            .borderRadius('6vp')
                            .padding({ left: '2vp', right: '2vp', top: '1vp', bottom: '1vp' })
                            .position({ x: '15vp', y: '-3vp' })
                        }
                      }
                      .width('30vp')
                      .height('30vp')
                      .alignContent(Alignment.Center)
                      .margin({ bottom: '6vp' })

                      Text(item.text)
                        .fontSize('10fp')
                        .fontColor('#666666')
                        .textAlign(TextAlign.Center)
                    }
                    .width('100%')
                    .height('70vp')
                    .justifyContent(FlexAlign.Center)
                    .alignItems(HorizontalAlign.Center)
                  }
                })
              }
              .columnsTemplate('1fr 1fr 1fr 1fr')
              .rowsTemplate('1fr 1fr')
              .width('100%')
              .height('140vp')
            }
            .width('100%')
            .padding({ left: '16vp', right: '16vp' })
            .margin({ bottom: '20vp' })
          }
        }
        .width('100%')
        .height('100%')
        .backgroundColor('#F5F5F5')
        .scrollBar(BarState.Off)
      } else {
        // Êú™ÁôªÂΩïÁä∂ÊÄÅ
        Column() {
          Text('üë§')
            .fontSize('60fp')
            .width('80vp')
            .height('80vp')
            .textAlign(TextAlign.Center)
            .backgroundColor('#E0E0E0')
            .borderRadius('40vp')
            .margin({ top: '100vp', bottom: '20vp' })
          
          Text('ËØ∑ÂÖàÁôªÂΩï')
            .fontSize('18fp')
            .fontWeight(FontWeight.Medium)
            .fontColor('#99182431')
            .margin({ bottom: '40vp' })
        }
        .width('100%')
        .height('100%')
        .alignItems(HorizontalAlign.Center)
        .backgroundColor('#F5F5F5')
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }
}