// utils/AuthService.ts
import { promptAction } from '@kit.ArkUI';
import { HttpUtils } from 'utils';
import preferences from '@ohos.data.preferences';

// å®šä¹‰APIå“åº”ç±»å‹
interface ApiResult<T> {
  code: number;
  message: string;
  data: T | null;
}

interface LoginFormData {
  userPhone: string;
  userPassword: string;
}

interface LoginResponse {
  code: number;
  message: string;
  data?: string; // JWT token
}

/**
 * è®¤è¯æœåŠ¡ï¼ˆåŒ…å«ç™»å½•å’Œæ³¨å†Œï¼‰
 */
export class AuthService {
  private static instance: AuthService | null = null;

  private constructor() {}

  /**
   * è·å–å•ä¾‹å®ä¾‹
   */
  public static getInstance(): AuthService {
    if (!AuthService.instance) {
      AuthService.instance = new AuthService();
    }
    return AuthService.instance;
  }

  /**
   * ç”¨æˆ·ç™»å½•æ–¹æ³•
   * @param phone æ‰‹æœºå·
   * @param password å¯†ç 
   * @returns Promise<boolean> ç™»å½•æ˜¯å¦æˆåŠŸ
   */
  async login(phone: string, password: string): Promise<boolean> {
    try {
      console.log('========== å¼€å§‹ç™»å½•è¯·æ±‚ ==========');
      console.log('ğŸ“± æ‰‹æœºå·:', phone);
      console.log('ğŸ”’ å¯†ç :', password ? '***ï¼ˆå·²è®¾ç½®ï¼‰' : 'ï¼ˆç©ºï¼‰');

      const url = 'http://hmos.w1.luyouxia.net/api/users/login';
      console.log('ğŸŒ è¯·æ±‚URL:', url);

      const formData: LoginFormData = {
        userPhone: phone,
        userPassword: password
      };
      console.log('ğŸ“¦ ç™»å½•å‚æ•°å¯¹è±¡:', JSON.stringify(formData));
      console.log('ğŸ“¦ formData.userPhone:', formData.userPhone);
      console.log('ğŸ“¦ formData.userPassword:', formData.userPassword);

      // å‘é€POSTè¯·æ±‚
      const respText = await HttpUtils.postForm(url, formData);
      console.log('âœ… å“åº”æ•°æ®:', respText);

      // è§£æå“åº”
      const resp: LoginResponse = JSON.parse(respText);
      console.log('è§£æåçš„å“åº”:', resp);

      if (resp.code === 200 && resp.data) {
        // ç™»å½•æˆåŠŸï¼Œä¿å­˜JWT
        await this.saveJWT(resp.data);
        promptAction.showToast({ message: 'ç™»å½•æˆåŠŸ' });
        console.log('âœ… ç™»å½•æˆåŠŸï¼');
        return true;
      } else {
        promptAction.showToast({ message: `ç™»å½•å¤±è´¥: ${resp.message}` });
        console.error(`âŒ ç™»å½•å¤±è´¥ï¼é”™è¯¯ç : ${resp.code}, æ¶ˆæ¯: ${resp.message}`);
        return false;
      }
    } catch (err) {
      console.error('ç™»å½•è¯·æ±‚å¤±è´¥:', err);
      promptAction.showToast({ message: `è¯·æ±‚å¼‚å¸¸: ${err.message}` });
      return false;
    }
  }

  /**
   * ä¿å­˜JWTåˆ°æœ¬åœ°å­˜å‚¨
   * @param token JWTä»¤ç‰Œ
   */
  private async saveJWT(token: string): Promise<void> {
    try {
      const pref = await preferences.getPreferences(globalThis.abilityContext, 'user_prefs');
      await pref.put('jwt_token', token);
      await pref.flush();
      console.log('JWTä¿å­˜æˆåŠŸ');
    } catch (error) {
      console.error('ä¿å­˜JWTå¤±è´¥:', error.message);
    }
  }

  /**
   * è·å–ä¿å­˜çš„JWT
   * @returns Promise<string | null> JWTä»¤ç‰Œ
   */
  async getJWT(): Promise<string | null> {
    try {
      const pref = await preferences.getPreferences(globalThis.abilityContext, 'user_prefs');
      const token = await pref.get('jwt_token', '');
      return token ? token.toString() : null;
    } catch (error) {
      console.error('è·å–JWTå¤±è´¥:', error.message);
      return null;
    }
  }

  /**
   * æ¸…é™¤JWTï¼ˆç”¨äºç™»å‡ºï¼‰
   */
  async clearJWT(): Promise<void> {
    try {
      const pref = await preferences.getPreferences(globalThis.abilityContext, 'user_prefs');
      await pref.delete('jwt_token');
      await pref.flush();
      console.log('JWTæ¸…é™¤æˆåŠŸ');
    } catch (error) {
      console.error('æ¸…é™¤JWTå¤±è´¥:', error.message);
    }
  }
}